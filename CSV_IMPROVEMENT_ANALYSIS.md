# CSV斷句問題分析

## 問題描述
用戶提供的CSV文件顯示了目前的斷句問題，主要體現在以下欄位：

### 1. "來源"欄位問題
```
"桃園長庚
門診
1132071036"
```
- 包含醫院名稱、門診類型、機構代碼三行
- 換行符在CSV中造成格式混亂

### 2. "主診斷"欄位問題
```
"有猝倒的猝睡症
G47411"
```
- 包含診斷名稱和診斷代碼兩行
- 換行符影響CSV可讀性

### 3. 其他多行欄位
- 某些藥品名稱可能包含換行符
- ATC3名稱中的中英文混合內容

## 改良策略

### 1. 換行符處理
- 將換行符 `\n` 替換為適當的分隔符
- 使用 ` | ` 或 ` / ` 作為分隔符，保持可讀性

### 2. 特定欄位優化
- **來源欄位**：桃園長庚 | 門診 | 1132071036
- **主診斷欄位**：有猝倒的猝睡症 | G47411
- **藥品名稱**：保持原始格式，但移除不必要的換行

### 3. CSV格式改進
- 確保所有欄位都在同一行
- 保持資料完整性
- 提高Excel等軟體的相容性

## 實現方案

### 1. 修改convertToCSV函數
```javascript
function convertToCSV(tableData) {
  if (!tableData || !tableData.length) return '';
  
  const header = Object.keys(tableData[0]).join(',');
  const rows = tableData.map(row => {
    return Object.values(row)
      .map(value => {
        // 改良斷句處理
        let processedValue = String(value)
          .replace(/\n/g, ' | ')  // 換行符替換為分隔符
          .replace(/\r/g, '')     // 移除回車符
          .trim();                // 移除首尾空白
        
        return `"${processedValue.replace(/"/g, '""')}"`;
      })
      .join(',');
  });
  
  return [header, ...rows].join('\n');
}
```

### 2. 可選的進階處理
- 針對特定欄位進行專門處理
- 保留重要的結構化信息
- 提供用戶自定義分隔符選項

## 預期效果

### 改良前
```
"桃園長庚
門診
1132071036"
```

### 改良後
```
"桃園長庚 | 門診 | 1132071036"
```

這樣的改良將：
1. 保持資料完整性
2. 提高CSV可讀性
3. 改善Excel等軟體的相容性
4. 便於後續資料處理和分析

