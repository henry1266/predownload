# URL 跳轉監測模式說明 v2.0.3

## 功能概述

根據用戶需求，已將監測邏輯修正為**URL 跳轉監測模式**。工具現在會監測頁面在失敗頁面和成功頁面之間的跳轉，只在成功跳轉到目標頁面時觸發資料檢查和擷取動作。

## 正確的監測邏輯

### 1. 頁面跳轉行為
- **失敗時**：頁面跳轉到 `https://medcloud2.nhi.gov.tw/imu/IMUE1000/#`
- **成功時**：頁面跳轉到 `https://medcloud2.nhi.gov.tw/imu/IMUE1000/IMUE0008`
- **跳轉特性**：頁面會在這兩個網址之間**跳來跳去**

### 2. 監測策略
- **監測目標**：URL 變化事件，特別是成功跳轉到 `/IMUE0008` 的事件
- **持續監測**：跳回失敗頁面 (`/#`) 時**不停止監測**，繼續等待下次成功跳轉
- **觸發條件**：只有在成功跳轉到目標頁面時才檢查資料並執行動作
- **循環支援**：支援多次跳轉檢測，每次成功跳轉都會觸發檢查

## 工作原理

### 1. URL 監測機制
```javascript
// 每 500ms 檢查一次 URL 變化
function checkUrlChange() {
  const newUrl = window.location.href;
  
  if (newUrl !== currentUrl) {
    jumpCount++; // 記錄跳轉次數
    
    if (isUrlTargetPage(newUrl)) {
      // 成功跳轉到目標頁面
      successfulJumps++;
      setTimeout(() => {
        checkDataAfterSuccessfulJump();
      }, 2000); // 延遲 2 秒確保頁面載入完成
    }
    
    currentUrl = newUrl;
  }
}
```

### 2. 資料檢查邏輯
- **觸發時機**：成功跳轉到 `/IMUE0008` 後 2 秒
- **資料比較**：使用雜湊值比較檢測資料變化
- **去重機制**：避免重複處理相同的資料
- **冷卻期間**：處理完成後 5 秒內不重複處理

### 3. 跳轉統計
- **總跳轉次數**：記錄所有 URL 變化
- **成功跳轉次數**：記錄跳轉到目標頁面的次數
- **即時顯示**：在彈出視窗中即時更新統計資訊

## 使用流程

### 步驟 1：開始監測
1. 瀏覽至相關頁面（任一頁面都可以）
2. 點擊擴充功能圖示
3. 點擊「**開始監測**」按鈕
4. 狀態顯示：「正在監測 URL 跳轉」

### 步驟 2：等待跳轉
- **當前在失敗頁面**：等待跳轉到目標頁面
- **當前在目標頁面**：立即檢查一次資料，然後繼續監測後續跳轉
- **跳轉過程**：工具會自動檢測每次 URL 變化

### 步驟 3：自動處理
- **成功跳轉檢測**：檢測到跳轉到 `/IMUE0008` 時
- **延遲檢查**：等待 2 秒確保頁面完全載入
- **資料比較**：檢查是否有新資料
- **自動動作**：有新資料時自動擷取並儲存

### 步驟 4：持續監測
- **跳回失敗頁面**：不停止監測，繼續等待下次成功跳轉
- **多次跳轉**：支援無限次跳轉檢測
- **統計更新**：即時更新跳轉統計資訊

## 技術特點

### 1. 高頻率 URL 檢查
```javascript
const MONITOR_CONFIG = {
  urlCheckInterval: 500, // 每 500ms 檢查一次 URL
  dataCheckDelay: 2000,  // 跳轉後延遲 2 秒檢查資料
  cooldownPeriod: 5000   // 冷卻期間 5 秒
};
```

### 2. 智能頁面識別
- **目標頁面檢測**：`url.includes('/IMUE0008')`
- **起始頁面檢測**：`url.includes('/imu/IMUE1000/#')`
- **相關頁面檢測**：`url.includes('medcloud2.nhi.gov.tw/imu/IMUE1000/')`

### 3. 資料雜湊比較
```javascript
function generateDataHash(tableData, personalInfo) {
  const dataString = JSON.stringify({
    tableCount: tableData ? tableData.length : 0,
    tableData: tableData,
    personalInfo: personalInfo,
    url: window.location.href,
    jumpCount: jumpCount // 加入跳轉計數作為雜湊因子
  });
  
  // 生成雜湊值
  let hash = 0;
  for (let i = 0; i < dataString.length; i++) {
    const char = dataString.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return hash.toString();
}
```

### 4. 重試機制
- **最大重試次數**：3 次
- **重試間隔**：2 秒
- **重試條件**：跳轉後未找到資料時

## 用戶介面

### 1. 狀態顯示
- **監測中**：
  - 目標頁面：「目標頁面 - 監測跳轉事件」
  - 起始頁面：「起始頁面 - 等待跳轉到目標頁面」
  - 相關頁面：「相關頁面 - 監測跳轉事件」
  - 一般頁面：「一般頁面 - 監測跳轉事件」

### 2. 跳轉統計
- **總跳轉次數**：顯示所有 URL 變化次數
- **成功跳轉**：顯示跳轉到目標頁面的次數（綠色高亮）
- **即時更新**：每次跳轉後立即更新統計

### 3. 通知系統
- **跳轉通知**：
  - 🎯 「成功跳轉到目標頁面！(第 X 次)」
  - ↩️ 「跳轉回起始頁面，繼續等待下次成功跳轉」
  - 🔄 「頁面跳轉中...」
- **資料通知**：
  - ✅ 「跳轉後檢測到新資料！共 X 筆記錄 (第 X 次成功跳轉)」
  - ℹ️ 「跳轉成功，但資料無變化」

## 配置參數

```javascript
const MONITOR_CONFIG = {
  startUrl: 'https://medcloud2.nhi.gov.tw/imu/IMUE1000/#',     // 失敗頁面
  targetUrl: 'https://medcloud2.nhi.gov.tw/imu/IMUE1000/IMUE0008', // 成功頁面
  urlCheckInterval: 500,    // URL 檢查間隔 (毫秒)
  dataCheckDelay: 2000,     // 跳轉後延遲檢查資料的時間
  maxRetries: 3,            // 最大重試次數
  cooldownPeriod: 5000      // 冷卻期間 (5秒)
};
```

## 適用場景

### 1. 醫療查詢系統
- **健保雲端系統**：查詢結果會在失敗和成功頁面間跳轉
- **醫院資訊系統**：查詢過程中的頁面跳轉
- **檢查結果查詢**：等待查詢完成的跳轉過程

### 2. 一般查詢系統
- **資料庫查詢**：查詢過程中的狀態跳轉
- **報表生成**：等待報表完成的頁面跳轉
- **任何具有查詢-等待-結果流程的系統**

## 優勢特點

### 1. 精確監測
- **事件驅動**：基於實際的 URL 變化事件
- **高頻檢查**：500ms 間隔確保不遺漏跳轉
- **智能識別**：準確識別目標頁面和起始頁面

### 2. 持續可靠
- **不間斷監測**：跳回失敗頁面時不停止監測
- **多次支援**：支援無限次跳轉檢測
- **錯誤恢復**：具備重試機制和錯誤處理

### 3. 用戶友善
- **即時反饋**：清楚的跳轉通知和狀態顯示
- **統計資訊**：詳細的跳轉統計和成功率
- **自動處理**：無需手動干預，自動檢測和處理

## 使用建議

### 1. 最佳實踐
- **提前開始**：在開始查詢前就啟動監測
- **保持頁面**：不要手動切換到其他頁面
- **注意通知**：關注瀏覽器通知了解跳轉狀態
- **檢查檔案**：定期檢查下載資料夾中的儲存檔案

### 2. 注意事項
- **網路穩定**：確保網路連線穩定，避免跳轉失敗
- **瀏覽器權限**：確保擴充功能有足夠權限
- **冷卻期間**：處理完成後 5 秒內不會重複處理相同資料
- **多標籤頁**：建議在單一標籤頁中使用，避免干擾

### 3. 故障排除
- **無法開始監測**：檢查是否在支援的頁面上
- **沒有檢測到跳轉**：確認頁面確實有 URL 變化
- **重複處理**：檢查冷卻期間設定，等待冷卻完成
- **統計不準確**：重新開始監測重置統計

## 版本資訊

- **版本號**：v2.0.3
- **發布日期**：2025-06-03
- **主要變更**：實現正確的 URL 跳轉監測邏輯
- **修正問題**：
  - 改為監測 URL 跳轉而非頁面重整
  - 跳回失敗頁面時不停止監測
  - 只在成功跳轉到目標頁面時觸發動作
  - 支援多次跳轉檢測和統計
- **相容性**：Chrome/Edge Manifest V3
- **GitHub**：https://github.com/henry1266/predownload.git

這個版本完全符合您的實際需求，正確地監測頁面在失敗和成功頁面之間的跳轉，並在每次成功跳轉時自動檢測和處理新資料，同時保持持續監測不會因跳回失敗頁面而停止。

