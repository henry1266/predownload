# 頁面重整觸發模式說明 v2.0.2

## 功能概述

根據用戶需求，已將監測邏輯修改為**頁面重整觸發模式**。工具現在會監測頁面重新載入事件，並在頁面重整完成後自動檢查是否有新資料。

## 工作原理

### 1. 監測機制
- **觸發條件**：頁面重新載入（手動重新整理或自動重新載入）
- **檢測時機**：頁面載入完成後 3 秒
- **檢測方式**：比較頁面重整前後的資料雜湊值
- **自動動作**：檢測到新資料時自動擷取並儲存

### 2. 使用流程

#### 步驟 1：開始監測
1. 瀏覽至目標頁面
2. 點擊擴充功能圖示
3. 點擊「開始監測」按鈕
4. 狀態顯示：「正在監測頁面重整」

#### 步驟 2：觸發檢測
**方式一：手動重新整理**
- 點擊瀏覽器的重新整理按鈕
- 使用快捷鍵 F5 或 Ctrl+R
- 點擊擴充功能中的「重新整理」按鈕

**方式二：等待自動重新載入**
- 某些系統會自動重新載入頁面
- 工具會自動檢測這些重新載入事件

#### 步驟 3：自動處理
- 頁面重整完成後，工具自動檢查資料變化
- 如果檢測到新資料，自動執行擷取和儲存
- 顯示通知：「頁面重整後檢測到新資料！共 X 筆記錄」

## 技術特點

### 1. 智能檢測
```javascript
// 檢查是否為頁面重整後的載入
function checkIfPageRefreshed() {
  const timeSinceLoad = Date.now() - pageLoadTime;
  
  if (timeSinceLoad < 5000) { // 5秒內載入的頁面
    console.log('檢測到頁面可能剛重整，延遲檢查資料...');
    
    setTimeout(() => {
      if (isMonitoring) {
        checkForDataChangesAfterRefresh();
      }
    }, MONITOR_CONFIG.checkDelay);
  }
}
```

### 2. 資料比較
- **雜湊生成**：包含表格資料、個人資料、URL 和頁面載入時間
- **變化檢測**：比較重整前後的資料雜湊值
- **去重機制**：避免重複處理相同的資料
- **冷卻期間**：處理完成後 10 秒內不重複處理

### 3. 事件監聽
```javascript
// 監聽頁面載入事件
function setupPageLoadListeners() {
  // 監聽頁面完全載入
  if (document.readyState === 'complete') {
    onPageFullyLoaded();
  } else {
    window.addEventListener('load', onPageFullyLoaded);
  }
  
  // 監聽 DOM 載入完成
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', onDOMLoaded);
  } else {
    onDOMLoaded();
  }
}
```

## 配置參數

```javascript
const MONITOR_CONFIG = {
  targetUrl: 'https://medcloud2.nhi.gov.tw/imu/IMUE1000/IMUE0008',
  checkDelay: 3000,      // 頁面載入後延遲檢查時間 (3秒)
  maxRetries: 3,         // 最大重試次數
  debounceDelay: 1000,   // 防抖延遲 (1秒)
  cooldownPeriod: 10000  // 冷卻期間 (10秒)
};
```

## 用戶介面

### 1. 狀態顯示
- **監測中**：「正在監測頁面重整」+ 綠色脈衝動畫
- **已停止**：「監測已停止」+ 灰色圓點
- **頁面狀態**：根據當前頁面類型顯示不同狀態

### 2. 控制按鈕
- **開始/停止監測**：切換監測狀態
- **手動擷取**：立即執行資料擷取（不受冷卻期間限制）
- **重新整理**：手動重新整理當前頁面

### 3. 資訊顯示
- **開始時間**：監測開始的時間
- **最後活動**：最後一次檢測或處理的時間
- **當前頁面**：顯示當前頁面的 URL

## 適用場景

### 1. 醫療資訊系統
- **健保雲端系統**：監測查詢結果的更新
- **醫院資訊系統**：監測病歷或檢查結果
- **藥品查詢系統**：監測用藥記錄更新

### 2. 一般網站
- **資料查詢頁面**：監測查詢結果更新
- **報表系統**：監測報表資料刷新
- **表格資料頁面**：監測任何表格資料變化

## 優勢特點

### 1. 用戶友善
- **被動監測**：不主動重新整理頁面，等待用戶或系統觸發
- **自動處理**：重新整理後自動檢測和處理，無需手動操作
- **即時回饋**：提供清楚的狀態顯示和通知

### 2. 技術穩定
- **事件驅動**：基於頁面載入事件，穩定可靠
- **錯誤恢復**：具備重試機制和錯誤處理
- **效能優化**：使用防抖和冷卻機制避免過度處理

### 3. 靈活配置
- **多頁面支援**：支援目標頁面、相關頁面和一般頁面
- **智能適配**：根據頁面類型自動調整監測策略
- **可擴展性**：易於添加新的頁面類型和處理邏輯

## 使用建議

### 1. 最佳實踐
- **開始監測**：在需要監測的頁面開啟監測功能
- **定期重新整理**：根據需要手動重新整理頁面
- **檢查通知**：注意瀏覽器通知，確認資料處理狀態
- **檢視檔案**：定期檢查下載資料夾中的儲存檔案

### 2. 注意事項
- **冷卻期間**：處理完成後 10 秒內不會重複處理相同資料
- **網路狀況**：確保網路連線穩定，避免頁面載入失敗
- **瀏覽器權限**：確保擴充功能有足夠的權限執行功能
- **檔案儲存**：確保瀏覽器下載設定允許自動下載檔案

### 3. 故障排除
- **無法開始監測**：檢查是否在支援的頁面上
- **沒有檢測到變化**：確認頁面確實有新資料載入
- **重複處理**：檢查冷卻期間設定，等待冷卻完成
- **檔案未儲存**：檢查瀏覽器下載權限和設定

## 版本資訊

- **版本號**：v2.0.2
- **發布日期**：2025-06-03
- **主要變更**：改為頁面重整觸發模式
- **相容性**：Chrome/Edge Manifest V3
- **GitHub**：https://github.com/henry1266/predownload.git

這個版本完全符合您的需求，工具現在會等待頁面重新整理，然後自動檢測和處理新資料，提供更符合實際使用場景的監測體驗。

