# 修改日誌 - 表格資料讀取問題修復

## 修改日期
2025-06-03

## 問題描述
用戶反映Chrome擴展可以截圖，但無法讀取健保醫療資訊雲端查詢系統的表格資料。

## 根本原因分析
1. **表格結構識別錯誤**：原代碼只是簡單查找第一個table元素，但健保系統使用DataTables，有複雜的嵌套結構
2. **表頭擷取不完整**：DataTables將表頭和資料分離在不同的容器中
3. **多行內容處理不當**：某些儲存格包含`<br>`標籤的多行內容未正確處理
4. **缺乏醫療系統專用邏輯**：沒有針對特定醫療系統的優化處理

## 修改內容

### 1. content.js 主要修改
- **新增 `extractDataTablesData()` 函數**：專門處理DataTables結構
- **改進 `extractGenericTableData()` 函數**：增強通用表格處理能力
- **新增醫療系統檢測**：`detectNHIMediCloudSystem()` 和 `detectMedicalSystem()`
- **新增專用處理邏輯**：`extractMedicalTableData()` 和 `extractNHIMediCloudData()`
- **新增資料後處理**：`postProcessNHIData()` 處理民國年轉換和多行資料
- **改進多行內容處理**：正確處理包含`<br>`標籤的儲存格
- **更新消息監聽器**：返回更詳細的回應格式

### 2. background.js 修改
- **改進錯誤處理**：更好的回應格式檢查和錯誤訊息
- **增強日誌記錄**：更詳細的操作日誌
- **改進回應格式**：統一的success/message格式

### 3. popup.js 修改
- **更新回應處理**：正確處理新的回應格式
- **改進錯誤顯示**：顯示更有意義的錯誤訊息
- **增強複製功能**：更好的狀態反饋

## 新增功能

### 1. DataTables 支援
- 自動識別DataTables結構
- 分別從scrollHead和scrollBody擷取表頭和資料
- 處理DataTables的特殊HTML結構

### 2. 健保系統專用處理
- 自動檢測健保醫療資訊雲端查詢系統
- 民國年日期自動轉換為西元年
- 來源欄位多行資料自動分解（醫院名稱、門診類型、機構代碼）

### 3. 多行內容處理
- 正確處理包含`<br>`標籤的儲存格
- 保持多行資料的結構完整性

### 4. 容錯機制
- 如果DataTables擷取失敗，自動回退到通用表格處理
- 更好的錯誤處理和用戶反饋
- 詳細的控制台日誌記錄

## 技術改進

### 1. 表格識別邏輯
```javascript
// 優先順序：DataTables > 通用表格
// 自動選擇最適合的擷取方法
```

### 2. 表頭處理
```javascript
// 從 .dataTables_scrollHead 擷取表頭
// 清理排序相關的屬性文字
```

### 3. 資料處理
```javascript
// 從 .dataTables_scrollBody 擷取資料
// 處理 <br> 標籤為換行符
```

## 測試建議
1. 在健保醫療資訊雲端查詢系統的用藥紀錄頁面測試
2. 驗證表格資料是否正確擷取
3. 檢查民國年日期轉換是否正確
4. 測試多行內容（如來源欄位）是否正確處理
5. 驗證在其他網站的通用表格擷取功能

## 預期效果
- 能夠正確擷取健保系統的表格資料
- 支援DataTables結構的網站
- 更好的錯誤處理和用戶體驗
- 保持對其他網站的相容性

